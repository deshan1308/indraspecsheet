Sub ExtractAllImagesImproved()
    Dim ws As Worksheet
    Dim shp As Shape
    Dim imgPath As String
    Dim imgName As String
    Dim i As Integer
    Dim sheetName As String
    Dim makeModel As String
    Dim imgFile As Object
    Dim tempChart As ChartObject
    
    ' Set output path (same folder as Excel file)
    imgPath = ThisWorkbook.Path & "\vehicle-images\"
    
    ' Create folder if it doesn't exist
    If Dir(imgPath, vbDirectory) = "" Then
        MkDir imgPath
    End If
    
    ' Process each worksheet
    For Each ws In ThisWorkbook.Worksheets
        sheetName = ws.Name
        
        ' Skip city-named sheets (they don't contain vehicle images)
        If LCase(sheetName) Like "*anuradhapura*" Or _
           LCase(sheetName) Like "*colombo*" Or _
           LCase(sheetName) Like "*kandy*" Or _
           LCase(sheetName) Like "*matara*" Or _
           LCase(sheetName) Like "*negambo*" Then
            GoTo NextSheet
        End If
        
        i = 1
        
        ' Extract make and model from sheet name
        makeModel = Replace(Replace(sheetName, " - ", "-"), " ", "-")
        makeModel = LCase(makeModel)
        
        ' Loop through all shapes (images) in the worksheet
        For Each shp In ws.Shapes
            ' Check if it's a picture
            If shp.Type = msoPicture Or shp.Type = msoLinkedPicture Or shp.Type = msoLinkedPictureOLEEmbed Then
                ' Generate filename: make-model-imagenumber.jpg
                imgName = makeModel & "-" & Format(i, "00") & ".jpg"
                
                ' Export the image using Export method (more reliable)
                On Error Resume Next
                
                ' Export the image using Chart.Export method
                shp.Copy
                Set tempChart = ws.ChartObjects.Add(0, 0, shp.Width, shp.Height)
                tempChart.Chart.Paste
                tempChart.Chart.Export imgPath & imgName, "JPG"
                tempChart.Delete
                
                On Error GoTo 0
                
                ' Verify file was created and has content
                If Dir(imgPath & imgName) <> "" Then
                    Dim fileSize As Long
                    fileSize = FileLen(imgPath & imgName)
                    If fileSize < 1000 Then
                        ' File too small, might be corrupted
                        Kill imgPath & imgName
                        Debug.Print "Warning: " & imgName & " is too small (" & fileSize & " bytes), skipped"
                    Else
                        Debug.Print "Extracted: " & imgName & " (" & fileSize & " bytes)"
                        i = i + 1
                    End If
                End If
            End If
        Next shp
        
        If i > 1 Then
            Debug.Print "Extracted " & (i - 1) & " image(s) from " & sheetName
        End If
        
NextSheet:
    Next ws
    
    MsgBox "Images extracted successfully!" & vbCrLf & _
           "Location: " & imgPath & vbCrLf & _
           "Please check the folder and verify image quality.", vbInformation
End Sub

